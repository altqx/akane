<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Akane Videos Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 40px; max-width: 1100px; }
    h1 { font-size: 1.8rem; margin-bottom: 0.25rem; }
    .subtitle { color: #6b7280; font-size: 0.9rem; margin-bottom: 1.5rem; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .top-nav { margin-bottom: 1.5rem; font-size: 0.9rem; }
    .top-nav a { color: #4b5563; }
    .filters { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; margin-bottom: 1rem; }
    .field { display: flex; flex-direction: column; gap: 0.25rem; }
    .field label { font-size: 0.85rem; color: #374151; font-weight: 500; }
    .field input[type="text"],
    .field select { padding: 6px 10px; border-radius: 4px; border: 1px solid #d1d5db; font-size: 0.9rem; min-width: 180px; }
    .field input[type="text"]:focus,
    .field select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 1px rgba(37,99,235,0.2); }
    button { padding: 7px 14px; border-radius: 4px; border: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; background: #111827; color: #fff; }
    button.secondary { background: #6b7280; }
    button:disabled { opacity: 0.6; cursor: default; }
    button:hover:not(:disabled) { background: #1f2937; }
    button.secondary:hover:not(:disabled) { background: #4b5563; }
    .table-wrapper { border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    thead { background: #f9fafb; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
    th { font-weight: 600; color: #374151; white-space: nowrap; }
    tbody tr:nth-child(even) { background: #f9fafb; }
    .tags { display: flex; flex-wrap: wrap; gap: 4px; }
    .tag { background: #e5e7eb; color: #374151; border-radius: 9999px; padding: 2px 8px; font-size: 0.75rem; }
    .resolutions { font-size: 0.8rem; color: #4b5563; }
    .muted { color: #9ca3af; font-size: 0.8rem; }
    .duration { font-variant-numeric: tabular-nums; }
    .thumb-img { width: 120px; max-height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #e5e7eb; }
    .thumb-empty { color: #9ca3af; font-size: 0.8rem; }
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; font-size: 0.85rem; }
    .pagination-controls { display: flex; gap: 0.5rem; }
    .status { margin-top: 0.75rem; font-size: 0.85rem; }
    .status.error { color: #b91c1c; }
    .status.info { color: #6b7280; }
  </style>
</head>
<body>
  <div class="top-nav">
    <a href="/index.html">&larr; Back to uploader</a>
  </div>
  <h1>Akane Videos Admin</h1>
  <div class="subtitle">
    Browse videos stored in <code>videos.db</code>, with search and pagination.
  </div>

  <div class="filters">
    <div class="field">
      <label for="nameFilter">Name contains</label>
      <input type="text" id="nameFilter" placeholder="Video name..." />
    </div>
    <div class="field">
      <label for="tagFilter">Tag contains</label>
      <input type="text" id="tagFilter" placeholder="e.g. gaming" />
    </div>
    <div class="field">
      <label for="pageSize">Page size</label>
      <select id="pageSize">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
      </select>
    </div>
    <div class="field">
      <button id="searchButton" type="button">Search</button>
    </div>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Tags</th>
          <th>Resolutions</th>
          <th>Duration</th>
          <th>Created at</th>
          <th>Playlist</th>
          <th>Thumbnail</th>
        </tr>
      </thead>
      <tbody id="videosBody">
        <tr>
          <td colspan="7" class="muted">No data loaded yet.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <div class="pagination-controls">
      <button id="prevPage" type="button" class="secondary" disabled>Prev</button>
      <button id="nextPage" type="button" class="secondary" disabled>Next</button>
    </div>
    <div id="pageInfo" class="muted">
      Page 1, no results yet.
    </div>
  </div>

  <div id="statusMessage" class="status info"></div>

  <script>
    const state = {
      page: 1,
      pageSize: 20,
      name: '',
      tag: '',
      total: 0,
      hasNext: false,
      hasPrev: false,
      loading: false,
    };

    const nameInput = document.getElementById('nameFilter');
    const tagInput = document.getElementById('tagFilter');
    const pageSizeSelect = document.getElementById('pageSize');
    const searchButton = document.getElementById('searchButton');
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    const bodyEl = document.getElementById('videosBody');
    const pageInfoEl = document.getElementById('pageInfo');
    const statusEl = document.getElementById('statusMessage');

    function setStatus(message, type) {
      statusEl.textContent = message || '';
      statusEl.classList.remove('error', 'info');
      if (!message) return;
      statusEl.classList.add(type || 'info');
    }

    function toQuery(params) {
      const search = new URLSearchParams();
      if (params.page) search.set('page', String(params.page));
      if (params.pageSize) search.set('page_size', String(params.pageSize));
      if (params.name) search.set('name', params.name);
      if (params.tag) search.set('tag', params.tag);
      return search.toString();
    }

    function formatDuration(seconds) {
      const s = Number(seconds) || 0;
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (h > 0) {
        return String(h).padStart(2, '0') + ':' +
               String(m).padStart(2, '0') + ':' +
               String(sec).padStart(2, '0');
      }
      return String(m).padStart(2, '0') + ':' +
             String(sec).padStart(2, '0');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text == null ? '' : String(text);
      return div.innerHTML;
    }

    function renderRows(items) {
      if (!items || items.length === 0) {
        bodyEl.innerHTML = '<tr><td colspan="7" class="muted">No videos found.</td></tr>';
        return;
      }

      const rows = items.map(item => {
        const tagsHtml = (item.tags || [])
          .map(t => '<span class="tag">' + escapeHtml(t) + '</span>')
          .join(' ');
        const resHtml = (item.available_resolutions || []).join(', ');
        const duration = formatDuration(item.duration);
        const createdAt = escapeHtml(item.created_at || '');

        let playlistHtml = '';
        if (item.playlist_url) {
          const url = escapeHtml(item.playlist_url);
          playlistHtml = '<a href="' + url + '" target="_blank" rel="noopener noreferrer">Open</a>';
        } else {
          playlistHtml = '<span class="muted">N/A</span>';
        }

        let thumbHtml = '';
        if (item.thumbnail_url) {
          const url = escapeHtml(item.thumbnail_url);
          thumbHtml = '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' +
                        '<img src="' + url + '" alt="Thumbnail" class="thumb-img" />' +
                      '</a>';
        } else {
          thumbHtml = '<span class="thumb-empty">No thumbnail</span>';
        }

        return (
          '<tr>' +
            '<td>' + escapeHtml(item.name) + '</td>' +
            '<td><div class="tags">' + tagsHtml + '</div></td>' +
            '<td class="resolutions">' + escapeHtml(resHtml) + '</td>' +
            '<td class="duration">' + escapeHtml(duration) + '</td>' +
            '<td>' + createdAt + '</td>' +
            '<td>' + playlistHtml + '</td>' +
            '<td>' + thumbHtml + '</td>' +
          '</tr>'
        );
      });

      bodyEl.innerHTML = rows.join('');
    }

    function updatePagination() {
      prevButton.disabled = !state.hasPrev || state.loading;
      nextButton.disabled = !state.hasNext || state.loading;

      if (state.total === 0) {
        pageInfoEl.textContent = 'No results.';
      } else {
        const from = (state.page - 1) * state.pageSize + 1;
        const to = Math.min(state.page * state.pageSize, state.total);
        pageInfoEl.textContent =
          'Showing ' + from + 'â€“' + to + ' of ' + state.total + ' videos (page ' + state.page + ').';
      }
    }

    async function loadVideos() {
      if (state.loading) return;
      state.loading = true;
      setStatus('Loading...', 'info');
      updatePagination();

      const query = toQuery({
        page: state.page,
        pageSize: state.pageSize,
        name: state.name.trim(),
        tag: state.tag.trim(),
      });

      try {
        const res = await fetch('/api/videos?' + query);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || 'Request failed');
        }
        const data = await res.json();

        state.page = data.page || state.page;
        state.pageSize = data.page_size || state.pageSize;
        state.total = data.total || 0;
        state.hasNext = !!data.has_next;
        state.hasPrev = !!data.has_prev;

        renderRows(data.items || []);
        updatePagination();
        if (state.total === 0) {
          setStatus('No videos matched the current filters.', 'info');
        } else {
          setStatus('', 'info');
        }
      } catch (err) {
        console.error('Failed to load videos', err);
        setStatus('Failed to load videos: ' + (err.message || String(err)), 'error');
        bodyEl.innerHTML =
          '<tr><td colspan="7" class="muted">Error loading data. See console for details.</td></tr>';
      } finally {
        state.loading = false;
        updatePagination();
      }
    }

    function applyFiltersAndReload() {
      state.name = nameInput.value || '';
      state.tag = tagInput.value || '';
      state.pageSize = Number(pageSizeSelect.value) || 20;
      state.page = 1;
      loadVideos();
    }

    searchButton.addEventListener('click', () => {
      applyFiltersAndReload();
    });

    nameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyFiltersAndReload();
      }
    });

    tagInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyFiltersAndReload();
      }
    });

    prevButton.addEventListener('click', () => {
      if (!state.hasPrev || state.loading) return;
      state.page = Math.max(1, state.page - 1);
      loadVideos();
    });

    nextButton.addEventListener('click', () => {
      if (!state.hasNext || state.loading) return;
      state.page = state.page + 1;
      loadVideos();
    });

    window.addEventListener('DOMContentLoaded', () => {
      loadVideos();
    });
  </script>
</body>
</html>