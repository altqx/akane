<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Akane Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 40px; max-width: 700px; }
    h1 { font-size: 1.8rem; }
    form { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }
    label { font-weight: 500; font-size: 0.9rem; color: #374151; margin-bottom: -8px; }
    input[type="file"] { padding: 6px 0; }
    input[type="text"] { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95rem; }
    input[type="text"]:focus { outline: none; border-color: #2563eb; }
    .input-hint { font-size: 0.85rem; color: #6b7280; margin-top: -8px; }
    button { padding: 8px 14px; border: none; background: #111827; color: #fff; border-radius: 4px; cursor: pointer; font-weight: 500; }
    button:hover:not(:disabled) { background: #1f2937; }
    button:disabled { opacity: 0.6; cursor: default; }
    button.secondary { background: #6b7280; }
    button.secondary:hover:not(:disabled) { background: #4b5563; }
    #result { margin-top: 20px; font-size: 0.95rem; }
    #result a { color: #2563eb; word-break: break-all; }
    .result-item { margin: 8px 0; padding: 8px 0; }
    .result-label { font-weight: 500; color: #374151; }
    #error { margin-top: 10px; color: #b91c1c; padding: 8px; background: #fef2f2; border-radius: 4px; display: none; }
    #error.show { display: block; }
    .progress { margin-top: 12px; display: none; }
    .progress.show { display: block; }
    .progress-item { margin-bottom: 12px; }
    .progress-stage { font-weight: 500; color: #374151; font-size: 0.9rem; margin-bottom: 4px; }
    .progress-bar { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: #2563eb; transition: width 0.3s; width: 0%; }
    .progress-info { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
    #fileList { margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 4px; display: none; }
    #fileList.show { display: block; }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
    .file-item:last-child { border-bottom: none; }
    .file-info { flex: 1; }
    .file-name { font-weight: 500; color: #1f2937; word-break: break-all; }
    .file-size { font-size: 0.85rem; color: #6b7280; }
    .file-status { font-size: 0.85rem; margin-left: 12px; }
    .file-status.pending { color: #6b7280; }
    .file-status.uploading { color: #2563eb; }
    .file-status.success { color: #16a34a; }
    .file-status.error { color: #b91c1c; }
    .file-actions { display: flex; gap: 6px; margin-left: 12px; }
    .file-actions button { padding: 4px 8px; font-size: 0.85rem; }
    .buttons-row { display: flex; gap: 8px; }
    .buttons-row button { flex: 1; }
  </style>
</head>
<body>
  <h1>Akane Video Uploader</h1>
  <form id="uploadForm">
    <label for="tagsInput">Tags (optional)</label>
    <input type="text" id="tagsInput" name="tags" placeholder="gaming, tutorial, 4k" />
    <div class="input-hint">Separate tags with commas (applied to all files)</div>
    
    <label for="fileInput">Video Files *</label>
    <input type="file" id="fileInput" name="files" accept="video/*,.mkv" required multiple />
    <div class="input-hint">Select one or more video files</div>
    
    <div id="fileList">
      <div id="fileListContent"></div>
    </div>
    
    <div class="buttons-row">
      <button type="submit">Upload All</button>
      <button type="reset" class="secondary">Clear</button>
    </div>

    <div class="progress" id="progress">
      <div id="progressContent"></div>
    </div>
  </form>
  <div id="result"></div>
  <div id="error"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const tagsInput = document.getElementById('tagsInput');
    const fileInput = document.getElementById('fileInput');
    const fileListEl = document.getElementById('fileList');
    const fileListContent = document.getElementById('fileListContent');
    const resultEl = document.getElementById('result');
    const errorEl = document.getElementById('error');
    const submitBtn = form.querySelector('button[type="submit"]');
    const progressEl = document.getElementById('progress');
    const progressContent = document.getElementById('progressContent');

    const uploadState = {
      files: [],
      results: [],
      progressInterval: null,
      currentUploadId: null
    };

    // Display selected files
    fileInput.addEventListener('change', (e) => {
      uploadState.files = Array.from(e.target.files);
      displayFileList();
      resultEl.innerHTML = '';
    });

    function displayFileList() {
      fileListContent.innerHTML = '';
      
      if (uploadState.files.length === 0) {
        fileListEl.classList.remove('show');
        return;
      }

      fileListEl.classList.add('show');
      uploadState.files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.id = `file-${index}`;
        fileItem.innerHTML = `
          <div class="file-info">
            <div class="file-name">${escapeHtml(file.name)}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
          <div class="file-status pending" id="status-${index}">Pending</div>
        `;
        fileListContent.appendChild(fileItem);
      });
    }

    async function pollProgress(uploadId) {
      try {
        const res = await fetch(`/progress/${uploadId}`);
        if (!res.ok) return;
        const progress = await res.json();
        if (progress) {
          displayProgress(progress);
        }
      } catch (err) {
        console.error('Progress poll error:', err);
      }
    }

    function displayProgress(progress) {
      const percentage = progress.percentage || 0;
      let html = `
        <div class="progress-item">
          <div class="progress-stage">${escapeHtml(progress.stage)}</div>
          <div class="progress-bar">
            <div class="progress-bar-fill" style="width: ${percentage}%"></div>
          </div>
          <div class="progress-info">
            ${progress.current_chunk} / ${progress.total_chunks} chunks - ${percentage}%
          </div>
        </div>
      `;
      progressContent.innerHTML = html;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultEl.innerHTML = '';
      errorEl.textContent = '';
      errorEl.classList.remove('show');
      progressEl.classList.remove('show');

      if (uploadState.files.length === 0) {
        showError('Please select at least one video file.');
        return;
      }

      const tags = tagsInput.value.trim();

      submitBtn.disabled = true;
      submitBtn.textContent = `Uploading (0/${uploadState.files.length})...`;
      progressEl.classList.add('show');
      uploadState.results = [];

      let completed = 0;
      const totalFiles = uploadState.files.length;

      for (let index = 0; index < uploadState.files.length; index++) {
        const file = uploadState.files[index];
        const statusEl = document.getElementById(`status-${index}`);
        
        statusEl.textContent = 'Uploading...';
        statusEl.classList.remove('pending');
        statusEl.classList.add('uploading');

        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('name', file.name.replace(/\.[^/.]+$/, ''));
          if (tags) {
            formData.append('tags', tags);
          }

          const res = await fetch('/upload', {
            method: 'POST',
            body: formData,
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Upload failed');
          }

          const data = await res.json();
          uploadState.currentUploadId = data.upload_id;

          // Start polling progress
          if (uploadState.progressInterval) clearInterval(uploadState.progressInterval);
          uploadState.progressInterval = setInterval(() => {
            if (uploadState.currentUploadId) {
              pollProgress(uploadState.currentUploadId);
            }
          }, 500);

          uploadState.results.push({
            file: file.name,
            success: true,
            data: data
          });

          statusEl.textContent = '✓ Success';
          statusEl.classList.remove('uploading');
          statusEl.classList.add('success');
        } catch (err) {
          uploadState.results.push({
            file: file.name,
            success: false,
            error: err.message || String(err)
          });

          statusEl.textContent = '✗ Failed';
          statusEl.classList.remove('uploading');
          statusEl.classList.add('error');
        }

        completed++;
        submitBtn.textContent = `Uploading (${completed}/${totalFiles})...`;
      }

      // Stop polling
      if (uploadState.progressInterval) {
        clearInterval(uploadState.progressInterval);
        uploadState.progressInterval = null;
      }

      // Display results
      displayResults();
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload All';
      setTimeout(() => {
        progressEl.classList.remove('show');
        progressContent.innerHTML = '';
      }, 1000);
    });

    function displayResults() {
      const successful = uploadState.results.filter(r => r.success);
      const failed = uploadState.results.filter(r => !r.success);

      let html = '';

      if (successful.length > 0) {
        html += `
          <div class="result-item">
            <div class="result-label">✓ ${successful.length} file(s) uploaded successfully!</div>
          </div>
        `;
        successful.forEach(result => {
          html += `
            <div class="result-item" style="margin-left: 12px; padding: 8px; background: #f0fdf4; border-radius: 4px;">
              <div class="result-label">${escapeHtml(result.file)}</div>
              <div class="result-label">Playlist URL:</div>
              <div><a href="${escapeHtml(result.data.playlist_url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(result.data.playlist_url)}</a></div>
            </div>
          `;
        });
      }

      if (failed.length > 0) {
        html += `
          <div class="result-item" style="color: #b91c1c; margin-top: 16px;">
            <div class="result-label">✗ ${failed.length} file(s) failed to upload</div>
          </div>
        `;
        failed.forEach(result => {
          html += `
            <div class="result-item" style="margin-left: 12px; padding: 8px; background: #fef2f2; border-radius: 4px; color: #b91c1c;">
              <div class="result-label">${escapeHtml(result.file)}</div>
              <div>${escapeHtml(result.error)}</div>
            </div>
          `;
        });
      }

      resultEl.innerHTML = html;
    }

    function showError(message) {
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
  </script>
</body>
</html>
